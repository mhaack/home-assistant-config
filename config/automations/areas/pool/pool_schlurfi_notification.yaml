---
# Send notication if pool cleaner is outside late in the evening
#
alias: "[Pool] Send alert when pool cleaner is still on"
trigger:
  platform: time
  at: "22:00:00"
condition:
  condition: and
  conditions:
    - condition: state
      entity_id: group.family
      state: "home"
    - condition: state
      entity_id: switch.pool_schlurfi
      state: "on"
    - condition: state
      entity_id: input_boolean.pool_schlurfi_notification
      state: "on"
    - condition: template
      value_template: >
        {% if states.automation.send_alert_when_pool_cleaner_is_still_on.last_triggered is not none %}
          {% if as_timestamp(now()) | int -  as_timestamp(states.automation.send_alert_when_pool_cleaner_is_still_on.attributes.last_triggered) | int > 1800 %}
          true
          {% else %}
          false
          {% endif %}
        {% else %}
        false
        {% endif %}
action:
  - service: switch.turn_off
    data:
      entity_id: switch.pool_schlurfi
  - service: notify.pushover_markus
    data:
      title: "JaMa Villa"
      message: "Achtung! Schlürfi war noch an, nicht vergessen ihn rein zu räumen."
