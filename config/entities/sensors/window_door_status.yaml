---
# Aggregated sensor holding the combined window & door state
#
platform: template
sensors:
  window_door_status:
    entity_id:
      - binary_sensor.fenster_arbeitszimmer_state
      - binary_sensor.fenster_essbereiclsh_state
      - binary_sensor.fenster_gaste_wc_state
      - binary_sensor.fenster_hwr_state
      - binary_sensor.fenster_kuche_state
      - binary_sensor.fenster_wohnzimmer_sofa_state
      - binary_sensor.fenster_wohnzimmer_state
      - binary_sensor.haustur_state
      - binary_sensor.schiebetur_wohnzimmer_state
      - binary_sensor.tur_carport_state
    value_template: >-
      {% macro contact_status() %}
      {% set open_windows = (states.binary_sensor|selectattr('entity_id','in',state_attr('group.window_sensors','entity_id'))|selectattr('state','eq','on')|list)|length %}
      {% set open_doors = (states.binary_sensor|selectattr('entity_id','in',state_attr('group.door_sensors','entity_id'))|selectattr('state','eq','on')|list)|length %}
      {% if open_windows == 0 and open_doors == 0 -%}
        Alles geschlossen
      {%- else -%}
        {% if open_doors > 0 -%}
          {% if open_doors == 1 -%}{{ open_doors}} Tür {% else -%}{{ open_doors}} Türen {% endif %}
        {%- endif %}
        {% if open_windows != 0 and open_doors != 0 -%}und {% endif %}
        {% if open_windows > 0 -%}{{ open_windows }} Fenster {% endif -%}
        offen
      {% endif %}
      {% endmacro %}
      {{ contact_status()}}
    friendly_name: Fenster & Türen
